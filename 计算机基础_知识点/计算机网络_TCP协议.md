## 1. 分层模型

<img src="./pic/tcp_1.png" style="zoom:100%;" />

### 1.1 应用层（Application Layer）

 应用层的本质是规定了应用程序之间如何相互传递报文， 以 HTTP 协议为例，它规定了 ：

- 报文的类型，是请求报文还是响应报文
- 报文的语法，报文分为几段，各段是什么含义、用什么分隔，每个部分的每个字段什么什么含义
- 进程应该以什么样的时序发送报文和处理响应报文

 HTTP 客户端和 HTTP 服务端的首要工作就是根据 HTTP 协议的标准组装和解析 HTTP 数据包，每个 HTTP 报文格式由三部分组成： 

- 起始行（start line），起始行根据是请求报文还是响应报文分为「请求行」和「响应行」。这个例子中起始行是`GET / HTTP/1.1`，表示这是一个 `GET` 请求，请求的 URL 为`/`，协议版本为`HTTP 1.1`，起始行最后会有一个空行`CRLF（\r\n)`与下面的首部分隔开
- 首部（header），首部采用形如`key:value`的方式，比如常见的`User-Agent`、`ETag`、`Content-Length`都属于 HTTP 首部，每个首部直接也是用空行分隔
- 可选的实体（entity），实体是 HTTP 真正要传输的内容，比如下载一个图片文件，传输的一段 HTML等

<img src="./pic/tcp_2.png" style="zoom:100%;" />

除了我们熟知的 HTTP 协议，还有下面这些非常常用的应用层协议

- 域名解析协议 DNS
- 收发邮件 SMTP 和 POP3 协议
- 时钟同步协议 NTP
- 网络文件共享协议 NFS

### 1.2 传输层（Transport Layer）

传输层的作用是为两台主机之间的「应用进程」提供端到端的逻辑通信，相隔几千公里的两台主机的进程就好像在直接通信一样。 

 虽然是叫传输层，但是并不是将数据包从一台主机传送到另一台，而是对「传输行为进行控制」 ，  TCP 协议就被称为传输控制协议（Transmission Control Protocol），为下面两层协议提供数据包的重传、流量控制、拥塞控制等。 

<img src="./pic/tcp_3.png" style="zoom:100%;" />

 传输层用端口号来标识不同的应用程序，主机收到数据包以后根据目标端口号将数据包传递给对应的应用程序进行处理。如下图中，目标端口号为 80，百度的服务器就根据这个目标端口号将请求交给监听 80 端口的应用程序（可能是 Nginx 等负载均衡器）处理 

<img src="./pic/tcp_4.png" style="zoom:100%;" />

### 1.3 网络互连层（Internet Layer）

 网络互连层提供了主机到主机的通信，将传输层产生的的数据包封装成分组数据包发送到目标主机，并提供路由选择的能力：

<img src="./pic/tcp_5.png" style="zoom:100%;" />

IP 协议是网络层的主要协议，TCP 和 UDP 都是用 IP 协议作为网络层协议。**这一层的主要作用是给包加上源地址和目标地址，将数据包传送到目标地址。**

IP 协议是一个无连接的协议，也不具备重发机制，这也是 TCP 协议复杂的原因之一就是基于了这样一个「不靠谱」的协议。

### 1.4 数据链路层

 以太网、Wifi、蓝牙工作在这一层，提供了主机连接到物理网络需要的硬件和相关的协议。

该层不做重点讨论。

 整体的分层图如下图所示 ：

<img src="./pic/tcp_6.png" style="zoom:100%;" />

**分层的好处是什么呢？**

分层的本质是通过分离关注点而让复杂问题简单化，通过分层可以做到：

- 各层独立：限制了依赖关系的范围，各层之间使用标准化的接口，各层不需要知道上下层是如何工作的，增加或者修改一个应用层协议不会影响传输层协议
- 灵活性更好：比如路由器不需要应用层和传输层，分层以后路由器就可以只用加载更少的几个协议层
- 易于测试和维护：提高了可测试性，可以独立的测试特定层，某一层有了更好的实现可以整体替换掉
- 能促进标准化：每一层职责清楚，方便进行标准化

## 2. TCP概述

 TCP 是一个可靠的（reliable）、面向连接的（connection-oriented）、基于字节流（byte-stream）、全双工的（full-duplex）协议。 

### 2.1 TCP 是面向连接的协议

- 面向连接（connection-oriented）：面向连接的协议要求正式发送数据之前需要通过「握手」建立一个**逻辑**连接，结束通信时也是通过有序的四次挥手来断开连接
- 无连接（connectionless）：无连接的协议则不需要

**三次握手**

 建立连接的过程是通过「三次握手」来完成的，顾名思义，通过三次数据交换建立一个连接。 **通过三次握手协商好双方后续通信的起始序列号、窗口缩放大小等信息。** 

<img src="./pic/tcp_7.png" style="zoom:100%;" />

















